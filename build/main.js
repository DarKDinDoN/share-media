!function(){"use strict";var e={921:function(e,a,t){var i=t(574),n=t(856),s=t(749);const o=new class{init(){this._createContainer(),this._activateListeners()}_createContainer(){const e=game.user.isGM?`<button class="dismiss"><i class="fas fa-times"></i> ${game.i18n.localize(`${i.Z.moduleName}.share.fullscreen-dismiss-button`)}</button>`:"";this.container=$('<div id="fullscreen-layer" class="hidden"></div>').append(`\n                <div class="background"></div>\n                <img src="${i.Z.modulePath}/images/transparent.png" alt="">\n                <video playsinline src="" class="disabled"></video>\n                <div class="darkness"></div>\n                <div class="buttons">\n                    ${e}\n                    <button class="minimize" title="${game.i18n.localize(`${i.Z.moduleName}.share.fullscreen-minimize-button`)}">\n                        <i class="fas fa-window-minimize"></i>\n                    </button>\n                    <button class="maximize hidden" title="${game.i18n.localize(`${i.Z.moduleName}.share.fullscreen-maximize-button`)}">\n                        <i class="fas fa-window-maximize"></i>\n                    </button>\n                </div>\n                <div class="title hidden"></div>\n            `);const a=document.querySelectorAll(".gm-screen-app, #dice-box-canvas");a?.[0]?this.container.insertBefore($(a[0])):this.container.insertBefore($(document.getElementById("pause")))}_activateListeners(){this.container.find("button.dismiss").click((e=>(0,s.Xy)())),this.container.find("button.minimize").click((e=>this.toggleMinimize())),this.container.find("button.maximize").click((e=>this.toggleMinimize()))}handleShare(e,a="image",t="",s=!1,o=!1,l=!0){const c=this.container.find(".background"),r=this.container.find("img"),d=this.container.find("video"),m=d.get(0),u=this.container.find(".minimize"),g=this.container.find(".maximize"),p=this.container.find(".title"),h=this.container.find(".darkness");if(s?this.container.addClass("immersive-mode"):this.container.removeClass("immersive-mode"),"image"===a&&(e.endsWith(".jpg")?c.css("background-image",`url("${e}")`):c.css("background-image",`url("${i.Z.modulePath}/images/black.png")`),d.addClass("disabled"),r.attr("src",e),r.removeClass("disabled")),"video"===a&&(c.css("background-image",`url("${i.Z.modulePath}/images/black.png")`),r.addClass("disabled"),d.attr("src",e),d.removeClass("disabled"),m.loop=o,m.muted=l,m.onended=o?null:()=>this.handleDismiss(),m.play().catch((e=>{m.muted=!0,m.play()}))),t?(p.html(t),p.removeClass("hidden")):p.addClass("hidden"),game.settings.get(i.Z.moduleName,n.L.FULLSCREEN_DARKNESS_MODE)&&game.scenes.current){const e=game.scenes.current;h.css("opacity",e.darkness),h.css("background-color",`#${CONFIG.Canvas.darknessColor.toString(16)}`)}this.container.removeClass("hidden"),this.container.removeClass("minimized"),u.removeClass("hidden"),g.addClass("hidden")}handleDismiss(){const e=this.container.find(".background"),a=this.container.find("img"),t=this.container.find("video"),n=t.get(0),s=this.container.find(".title"),o=this.container.find(".darkness");e.css("background-image",`url("${i.Z.modulePath}/images/transparent.png")`),a.attr("src",`${i.Z.modulePath}/images/transparent.png`),n.pause(),t.attr("src",""),s.html(""),s.addClass("hidden"),o.css("opacity",0),o.css("background-color","transparent"),this.container.addClass("hidden")}toggleMinimize(e){const a=this.container.find(".minimize"),t=this.container.find(".maximize"),i=this.container.find(".title"),n=this.container.find(".darkness");a.toggleClass("hidden"),t.toggleClass("hidden"),i.toggleClass("hidden"),n.toggleClass("hidden"),this.container.toggleClass("minimized")}updateDarkness(e){if(game.settings.get(i.Z.moduleName,n.L.FULLSCREEN_DARKNESS_MODE)&&!this.container.hasClass("hidden")){const a=this.container.find(".darkness");a.css("opacity",e),a.css("background-color",`#${CONFIG.Canvas.darknessColor.toString(16)}`)}}};a.Z=o},574:function(e,a){a.Z={modulePath:"modules/share-media",moduleName:"share-media"}},856:function(e,a,t){t.d(a,{L:function(){return o},Y:function(){return l}});var i=t(574);class n extends FormApplication{static init(){game.settings.registerMenu(i.Z.moduleName,o.BLACKLIST_FORM,{label:game.i18n.localize("share-media.settings.blacklist-label-menu"),icon:"fas fa-ban",type:n,restricted:!0}),game.settings.register(i.Z.moduleName,o.BLACKLIST,{type:n,scope:"world",config:!1,default:"",type:String})}static get defaultOptions(){return mergeObject(super.defaultOptions,{...super.defaultOptions,template:`${i.Z.modulePath}/templates/blacklist-settings.hbs`,height:375,title:game.i18n.localize("share-media.dialogs.blacklist-settings.title"),width:400,id:"share-media-blacklist-settings"})}getData(){let e=super.getData();const a=game.settings.get(i.Z.moduleName,o.BLACKLIST).split(";");return e.players=game.users.map((e=>({id:e.id,name:e.name,color:e.color,active:e.active,checked:a.includes(e.id)}))),e}_updateObject(e,a){const t=expandObject(a);game.settings.set(i.Z.moduleName,o.BLACKLIST,t.playerId?.join(";")||"")}}const s=foundry.utils.debounce((()=>window.location.reload()),500),o={DISABLE_CONTEXT_OPTIONS:"disable-context-options",VIDEO_LOOPING_OPTION:"video-looping-option",VIDEO_MUTE_OPTION:"video-muted-option",ENABLE_HUD_BUTTON:"enable-hud-button",FULLSCREEN_IMMERSIVE_MODE:"fullscreen-immersive-mode",FULLSCREEN_DARKNESS_MODE:"fullscreen-darkness-mode",SHARE_ACTOR_TOKEN_NAME:"popout-share-name",ENABLE_SCENE_COVER:"enable-scene-cover",BLACKLIST_FORM:"blacklist-form",BLACKLIST:"blacklist"};function l(){game.settings.register(i.Z.moduleName,o.DISABLE_CONTEXT_OPTIONS,{name:game.i18n.localize("share-media.settings.disable-context-options-name"),hint:game.i18n.localize("share-media.settings.disable-context-options-hint"),scope:"world",config:!0,default:!1,type:Boolean,onChange:()=>s()}),game.settings.register(i.Z.moduleName,o.VIDEO_LOOPING_OPTION,{name:game.i18n.localize("share-media.settings.video-looping-option-name"),hint:game.i18n.localize("share-media.settings.video-looping-option-hint"),scope:"world",config:!0,default:!1,type:Boolean,onChange:()=>s()}),game.settings.register(i.Z.moduleName,o.VIDEO_MUTE_OPTION,{name:game.i18n.localize("share-media.settings.video-mute-option-name"),hint:game.i18n.localize("share-media.settings.video-mute-option-hint"),scope:"world",config:!0,default:!0,type:Boolean,onChange:()=>s()}),game.settings.register(i.Z.moduleName,o.ENABLE_HUD_BUTTON,{name:game.i18n.localize("share-media.settings.enable-hud-button-name"),hint:game.i18n.localize("share-media.settings.enable-hud-button-hint"),scope:"world",config:!0,default:!0,type:Boolean,onChange:()=>s()}),game.settings.register(i.Z.moduleName,o.FULLSCREEN_IMMERSIVE_MODE,{name:game.i18n.localize("share-media.settings.fullscreen-immersive-mode-name"),hint:game.i18n.localize("share-media.settings.fullscreen-immersive-mode-hint"),scope:"world",config:!0,default:!1,type:Boolean,onChange:()=>s()}),game.settings.register(i.Z.moduleName,o.FULLSCREEN_DARKNESS_MODE,{name:game.i18n.localize("share-media.settings.fullscreen-darkness-mode-name"),hint:game.i18n.localize("share-media.settings.fullscreen-darkness-mode-hint"),scope:"world",config:!0,default:!0,type:Boolean,onChange:()=>s()}),game.settings.register(i.Z.moduleName,o.SHARE_ACTOR_TOKEN_NAME,{name:game.i18n.localize("share-media.settings.share-actor-token-name-name"),hint:game.i18n.localize("share-media.settings.share-actor-token-name-hint"),scope:"world",config:!0,default:!1,type:Boolean,onChange:()=>s()}),game.settings.register(i.Z.moduleName,o.ENABLE_SCENE_COVER,{name:game.i18n.localize("share-media.settings.enable-scene-cover-name"),hint:game.i18n.localize("share-media.settings.enable-scene-cover-hint"),scope:"world",config:!0,default:!1,type:Boolean,onChange:()=>s()}),n.init()}},749:function(e,a,t){t.d(a,{Xy:function(){return m},tW:function(){return l},J6:function(){return r}});var i=t(574);class n extends ImagePopout{constructor(e,a={}){super(e,a),this.video=[".mp4","webm"].includes(e.slice(-4).toLowerCase()),this.options.template=`${i.Z.modulePath}/templates/media-popout-dialog.hbs`}async getData(e){let a=await super.getData();return a.isVideo=this.video,a}static _handleShareMedia(e,a="",t=!1,i=!0){const n=new this(e,{title:a,shareable:!1,editable:!1}).render(!0);n.video&&setTimeout((()=>{const e=n.element.find("video")[0];e.loop=t,e.muted=i,e.onended=t?null:()=>n.close(!0),e.play().catch((a=>{e.muted=!0,e.play()}))}),250)}}var s=t(921);let o;Hooks.once("socketlib.ready",(()=>{o=socketlib.registerModule(i.Z.moduleName),o.register("sharePopoutMedia",c),o.register("shareFullscreenMedia",d),o.register("dismissFullscreenMedia",u)}));const l=async(e,a,t="",i=!1,n=!0)=>await o.executeForUsers("sharePopoutMedia",a,e,t,i,n),c=(e,a="",t=!1,i=!0)=>{n._handleShareMedia(e,a,t,i)},r=async(e,a,t="image",i="",n=!1,s=!1,l=!0)=>await o.executeForUsers("shareFullscreenMedia",a,e,t,i,n,s,l),d=(e,a="image",t="",i=!1,n=!1,o=!0)=>{s.Z.handleShare(e,a,t,i,n,o)},m=async()=>await o.executeForEveryone("dismissFullscreenMedia"),u=()=>{s.Z.handleDismiss()}}},a={};function t(i){var n=a[i];if(void 0!==n)return n.exports;var s=a[i]={exports:{}};return e[i](s,s.exports,t),s.exports}t.d=function(e,a){for(var i in a)t.o(a,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:a[i]})},t.o=function(e,a){return Object.prototype.hasOwnProperty.call(e,a)},function(){var e=t(856),a=t(574),i=t(749);const n=async(t,n,s="image",o="",l=!1,c=!1,r=!0)=>{const m=game.settings.get(a.Z.moduleName,e.L.BLACKLIST).split(";"),u="all"===n?game.users.filter((e=>e.active&&!m.includes(e.id))).map((e=>e.id)):await async function(e){e.sort(((e,a)=>+a.active-+e.active||e.name.localeCompare(a.name)));const t=await renderTemplate(`${a.Z.modulePath}/templates/players-selection-dialog.hbs`,{players:e});return d({id:"player-selection-dialog",title:game.i18n.localize(`${a.Z.moduleName}.dialogs.players-selection.title`),content:t,cancelLabel:game.i18n.localize(`${a.Z.moduleName}.dialogs.players-selection.cancel-button`),validateLabel:game.i18n.localize(`${a.Z.moduleName}.dialogs.players-selection.share-button`),validateCallback:e=>e.find("input:checkbox[name=playerId]:checked").get().map((e=>$(e).val()))})}(game.users.filter((e=>!m.includes(e.id))).map((e=>({id:e.id,name:e.name,color:e.color,active:e.active,isGM:e.isGM}))));await(0,i.J6)(t,u,s,o,l,c,r),ui.notifications.info(game.i18n.localize(`${a.Z.moduleName}.share.fullscreen-success-${n}`))},s=async(t,n,s="",o=!1,l=!0)=>{const c=game.settings.get(a.Z.moduleName,e.L.BLACKLIST).split(";"),r="all"===n?game.users.filter((e=>e.active&&!c.includes(e.id))).map((e=>e.id)):await async function(e){e.sort(((e,a)=>+a.active-+e.active||e.name.localeCompare(a.name)));const t=await renderTemplate(`${a.Z.modulePath}/templates/players-selection-dialog.hbs`,{players:e});return d({id:"player-selection-dialog",title:game.i18n.localize(`${a.Z.moduleName}.dialogs.players-selection.title`),content:t,cancelLabel:game.i18n.localize(`${a.Z.moduleName}.dialogs.players-selection.cancel-button`),validateLabel:game.i18n.localize(`${a.Z.moduleName}.dialogs.players-selection.share-button`),validateCallback:e=>e.find("input:checkbox[name=playerId]:checked").get().map((e=>$(e).val()))})}(game.users.filter((e=>!c.includes(e.id))).map((e=>({id:e.id,name:e.name,color:e.color,active:e.active,isGM:e.isGM}))));await(0,i.tW)(t,r,s,o,l),ui.notifications.info(game.i18n.localize(`${a.Z.moduleName}.share.popout-success-${n}`))};async function o(e=""){const t=r();if(!t.length)return ui.notifications.warn(game.i18n.localize(`${a.Z.moduleName}.bounding-tile.not-found`));let i;e&&(i=t.filter((t=>t.data.flags[a.Z.moduleName].name===e))),i||(i=t.length>1?await async function(e){const t=e.map((e=>({id:e.id,name:e.flags[a.Z.moduleName].name}))).sort(((e,a)=>e.name.localeCompare(a.name))),i=await renderTemplate(`${a.Z.modulePath}/templates/clear-bounding-tile-selection-dialog.hbs`,{boundingTiles:t});return d({id:"clear-bounding-tile-selection-dialog",title:game.i18n.localize(`${a.Z.moduleName}.dialogs.clear-bounding-tile-selection.title`),content:i,cancelLabel:game.i18n.localize(`${a.Z.moduleName}.dialogs.clear-bounding-tile-selection.cancel-button`),validateLabel:game.i18n.localize(`${a.Z.moduleName}.dialogs.clear-bounding-tile-selection.clear-button`),validateCallback:a=>{const t=a.find("input:radio[name=boundingTileId]:checked").get().map((e=>$(e).val()))[0];return[e.find((e=>e.id===t))]},otherButtons:[{id:"all",icon:'<i class="fas fa-check-double"></i>',label:game.i18n.localize(`${a.Z.moduleName}.dialogs.clear-bounding-tile-selection.clear-all-button`),callback:a=>e}],defaultButton:"all",top:ui.controls.element.position().top+110,left:ui.controls.element.position().left+110})}(t):t),i.forEach((async e=>{const t=e.parent.flags?.[a.Z.moduleName]?.[e.flags[a.Z.moduleName].name];t&&(delete foundry.utils.deepClone(e.parent.flags[a.Z.moduleName])[e.flags[a.Z.moduleName].name],await e.parent.unsetFlag(a.Z.moduleName,e.flags[a.Z.moduleName].name))})),ui.notifications.info(game.i18n.localize(`${a.Z.moduleName}.bounding-tile.clear-success`))}const l=async(e,t,i="image",n=!1,s=!0,o="")=>{if(!canvas.scene)return ui.notifications.warn(game.i18n.localize(`${a.Z.moduleName}.share.scene-no-scene`));const l=r();if(!l.length)return ui.notifications.warn(game.i18n.localize(`${a.Z.moduleName}.bounding-tile.not-found`));let c;o&&(c=l.find((e=>e.data.flags[a.Z.moduleName].name===o))),c||(c=l.length>1?await async function(e){const t=e.map((e=>({id:e.id,name:e.flags[a.Z.moduleName].name}))).sort(((e,a)=>e.name.localeCompare(a.name))),i=await renderTemplate(`${a.Z.modulePath}/templates/share-bounding-tile-selection-dialog.hbs`,{boundingTiles:t});return d({id:"share-bounding-tile-selection-dialog",title:game.i18n.localize(`${a.Z.moduleName}.dialogs.share-bounding-tile-selection.title`),content:i,cancelLabel:game.i18n.localize(`${a.Z.moduleName}.dialogs.share-bounding-tile-selection.cancel-button`),validateLabel:game.i18n.localize(`${a.Z.moduleName}.dialogs.share-bounding-tile-selection.share-button`),validateCallback:a=>{const t=a.find("input:radio[name=boundingTileId]:checked").get().map((e=>$(e).val()))[0];return e.find((e=>e.id===t))}})}(l):l[0]),await c.parent.setFlag(a.Z.moduleName,c.flags[a.Z.moduleName].name,{url:e,style:t,type:i,loop:n,mute:s}),ui.notifications.info(game.i18n.localize(`${a.Z.moduleName}.share.scene-success`))},c=e=>canvas.scene.tiles.find((t=>t.flags?.[a.Z.moduleName]?.isBounding&&t.flags?.[a.Z.moduleName]?.name===e)),r=()=>canvas.scene.tiles.filter((e=>e.flags?.[a.Z.moduleName]?.isBounding)),d=async({id:e,title:t,content:i,cancelLabel:n,validateLabel:s,validateCallback:o,otherButtons:l=[],defaultButton:c="validate",render:r=null,top:d=null,left:m=null})=>new Promise(((u,g)=>{const p={};l.forEach((e=>{p[e.id]={icon:e.icon,label:e.label,callback:a=>{u(e.callback(a))}}}));let h={};n&&(h=foundry.utils.mergeObject(h,{cancel:{icon:'<i class="fas fa-times"></i>',label:n,callback:()=>g}})),s&&o&&(h=foundry.utils.mergeObject(h,{validate:{icon:'<i class="fas fa-check"></i>',label:s,callback:e=>{u(o(e))}}})),h=foundry.utils.mergeObject(h,p),new Dialog({title:t,content:i,buttons:h,default:c,render:r},{id:`${a.Z.moduleName}-${e}`,top:d,left:m}).render(!0)})),m=async(e,t="")=>{const i=[{id:"share-popout-all",icon:'<i class="fas fa-book-open"></i>',label:game.i18n.localize(`${a.Z.moduleName}.dialogs.share-action.share-popout-all`),callback:a=>s(e,"all",t)},{id:"share-popout-some",icon:'<i class="fas fa-book-open"></i>',label:game.i18n.localize(`${a.Z.moduleName}.dialogs.share-action.share-popout-some`),callback:a=>s(e,"some",t)},{id:"share-fullscreen-all",icon:'<i class="fas fa-expand-arrows-alt"></i>',label:game.i18n.localize(`${a.Z.moduleName}.dialogs.share-action.share-fullscreen-all`),callback:a=>n(e,"all","image",t)},{id:"share-fullscreen-some",icon:'<i class="fas fa-expand-arrows-alt"></i>',label:game.i18n.localize(`${a.Z.moduleName}.dialogs.share-action.share-fullscreen-some`),callback:a=>n(e,"some","image",t)},{id:"share-scene-fit",icon:'<i class="fas fas fa-map"></i>',label:game.i18n.localize(`${a.Z.moduleName}.dialogs.share-action.share-scene-fit`),callback:a=>l(e,"fit")},{id:"share-scene-cover",icon:'<i class="fas fas fa-map"></i>',label:game.i18n.localize(`${a.Z.moduleName}.dialogs.share-action.share-scene-cover`),callback:a=>l(e,"cover")}],o=await renderTemplate(`${a.Z.modulePath}/templates/choose-share-action-dialog.hbs`);return d({id:"choose-share-action-dialog",content:o,title:game.i18n.localize(`${a.Z.moduleName}.dialogs.share-action.title`),otherButtons:i})};class u extends CanvasLayer{constructor(){super(),this.containers=[]}async _draw(){}static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:a.Z.moduleName,canDragCreate:!1,controllableObjects:!1,rotatableObjects:!1,snapToGrid:!1,quadtree:!1,elevationSorting:!1,sortActiveTop:!1,zIndex:0})}async createBoundedSprite(t,i,n,s=!1,o=!1,l=!0){if(game.settings.get(a.Z.moduleName,e.L.BLACKLIST).split(";").includes(game.user.id))return;const r=c(t);if(!r)return;const d=this._prepareContainer(t,r.z),m=await this._createSprite(i,s,r,o,l),u="fit"===n?this._calculateScaleFactorFit(m.width,m.height,r.width,r.height):this._calculateScaleFactorCover(m.width,m.height,r.width,r.height);m.scale.set(u);const g=this._calculateAspectRatioCoordinates(r.x,r.y,r.width,r.height,m.width,m.height);m.position.set(g.x,g.y),"cover"===n&&this._addMask(d,r.x,r.y,r.width,r.height),d.addChild(m)}deleteBoundedSprite(t){game.settings.get(a.Z.moduleName,e.L.BLACKLIST).split(";").includes(game.user.id)||(this.containers=this.containers.filter((e=>(e.parentName===t&&e.destroy({children:!0}),e.parentName!==t))))}_prepareContainer(e,a){this.deleteBoundedSprite(e);const t=new PIXI.Container;return t.sortableChildren=!0,t.parentName=e,t.zIndex=a,this.containers.push(t),this.addChild(t),this.sortChildren(),t}_addMask(e,a,t,i,n){const s=(new PIXI.Graphics).beginFill(16724736).drawRect(a,t,i,n).endFill();e.mask=s,e.addChild(s)}async _createSprite(e,t,i,n=!1,s=!0){const o=await loadTexture(e),l=new PIXI.Sprite(o);return t&&(game.user.isGM&&l.texture.baseTexture.resource.source.addEventListener("ended",(()=>{n||i.parent.unsetFlag(a.Z.moduleName,i.flags[a.Z.moduleName].name)})),l.texture.baseTexture.resource.source.loop=n,l.texture.baseTexture.resource.source.muted=s,l.texture.baseTexture.resource.source.play().catch((e=>{l.texture.baseTexture.resource.source.muted=!0,l.texture.baseTexture.resource.source.play()}))),l}_calculateScaleFactorFit(e,a,t,i){return t/i>e/a?i/a:t/e}_calculateScaleFactorCover(e,a,t,i){return t/i>e/a?t/e:i/a}_calculateAspectRatioCoordinates(e,a,t,i,n,s){return{x:e+t/2-n/2,y:a+i/2-s/2}}}var g=t(921);const p=t=>{t.find(["article.journal-entry-page.text :not(header) > img","article.journal-entry-page.text :not(header) > video","article.journal-entry-page.image :not(header) > img","article.journal-entry-page.video :not(header) > video","div.editor-content img:not([data-edit])","div.editor-content video:not([data-edit])","section.tab-container img:not([data-edit])",'section.tab-container input[type="image"]'].join(",")).each(((t,i)=>{const n=$(i);if("show-media"===n.parent().attr("id"))return;const s=n.is("img")||n.is('input[type="image"]')?"image":"video",o=n.innerWidth()<=350;!function(t,i,n="image",s=!1){const o=(e=>{const a=($(e).attr("style")||"").split(";");let t=a.length;const i=[];let n,s,o;for(;t--;)n=a[t].split(":"),s=$.trim(n[0]),o=$.trim(n[1]),s.length>0&&o.length>0&&(i[s]=o);return i})(t),l=["display","float","margin","margin-left","margin-right"].reduce(((e,a)=>o.hasOwnProperty(a)?`${e} ${a}: ${o[a]};`:e),"");if($(t).wrap(`<div id="show-media" class="clickable-media" style="${l||""}"></div>`).after('<div class="media-actions-container"></div>'),game.user.isGM){const o=game.settings.get(a.Z.moduleName,e.L.FULLSCREEN_IMMERSIVE_MODE);$(t).parent().find("div.media-actions-container").append(`\n                <div class="media-actions">\n                    <i class="drawer fas fa-book-open" title="${game.i18n.localize(`${a.Z.moduleName}.share.popout-button`)}"></i>\n                    <div class="actions">\n                            <span data-action="share-popout" data-mode="all" data-type="${n}" data-url="${i}" title="${game.i18n.localize(`${a.Z.moduleName}.share.popout-all-button`)}"><i class="fas fa-users"></i>${s?"":`&nbsp;&nbsp;${game.i18n.localize(`${a.Z.moduleName}.share.popout-all-button`)}`}</span>\n                            <span data-action="share-popout" data-mode="some" data-type="${n}" data-url="${i}" title="${game.i18n.localize(`${a.Z.moduleName}.share.popout-some-button`)}"><i class="fas fa-user-friends"></i>${s?"":`&nbsp;&nbsp;${game.i18n.localize(`${a.Z.moduleName}.share.popout-some-button`)}`}</span>\n                    </div>\n                </div>\n                <div class="media-actions">\n                    <i class="drawer fas fa-expand-arrows-alt" title="${game.i18n.localize(`${a.Z.moduleName}.share.fullscreen-button`)}"></i>\n                    <div class="actions">\n                        <span data-action="share-fullscreen" data-mode="all" data-url="${i}" data-type="${n}" title="${game.i18n.localize(`${a.Z.moduleName}.share.fullscreen-all-button`)}"><i class="fas fa-users"></i>${s?"":`&nbsp;&nbsp;${game.i18n.localize(`${a.Z.moduleName}.share.fullscreen-all-button`)}`}</span>\n                        <span data-action="share-fullscreen" data-mode="some" data-url="${i}" data-type="${n}" title="${game.i18n.localize(`${a.Z.moduleName}.share.fullscreen-some-button`)}"><i class="fas fa-user-friends"></i>${s?"":`&nbsp;&nbsp;${game.i18n.localize(`${a.Z.moduleName}.share.fullscreen-some-button`)}`}</span>\n                        <span data-action="share-fullscreen-immersive" data-action="immersive-mode" class="immersive-action ${o?"active":""}" data-value="${o}" title="${game.i18n.localize(`${a.Z.moduleName}.share.fullscreen-immersive-button`)}"><i class="fa-thin fa-arrows-maximize"></i>${s?"":`&nbsp;&nbsp;${game.i18n.localize(`${a.Z.moduleName}.share.fullscreen-immersive-button`)}`}</span>\n                    </div>\n                </div>\n                <div class="media-actions">\n                    <i class="drawer fas fa-map" title="${game.i18n.localize(`${a.Z.moduleName}.share.scene-button`)}"></i>\n                    <div class="actions">\n                        <span data-action="share-scene" data-style="fit" data-type="${n}" data-url="${i}" title="${game.i18n.localize(`${a.Z.moduleName}.share.scene-fit-button`)}"><i class="fas fa-compress-arrows-alt"></i>${s?"":`&nbsp;&nbsp;${game.i18n.localize(`${a.Z.moduleName}.share.scene-fit-button`)}`}</span>\n                        <span data-action="share-scene" data-style="cover" data-type="${n}" data-url="${i}" title="${game.i18n.localize(`${a.Z.moduleName}.share.scene-cover-button`)}"><i class="fas fa-expand"></i>${s?"":`&nbsp;&nbsp;${game.i18n.localize(`${a.Z.moduleName}.share.scene-cover-button`)}`}</span>\n                    </div>\n                </div>\n            `)}if("image"===n&&game.modules.get("foundryvtt-miro-connector")?.active&&window["foundryvtt-miro-connector"].MiroAPI){const e=game.settings.get("foundryvtt-miro-connector","player-api-access");(game.user.isGM||e)&&$(t).parent().find("div.media-actions-container").append(`\n                    <div class="media-actions miro-action" data-action="share-miro" data-url="${i}">\n                        <i class="drawer fas fa-cloud-upload-alt" title="${game.i18n.localize(`${a.Z.moduleName}.share.miro-button`)}"></i>\n                    </div>\n                `)}if(game.user.isGM&&"video"===n){const i=game.settings.get(a.Z.moduleName,e.L.VIDEO_LOOPING_OPTION),n=game.settings.get(a.Z.moduleName,e.L.VIDEO_MUTE_OPTION);$(t).parent().find("div.media-actions-container").append(`\n                    <div class="media-actions loop-action ${i?"active":""}" data-action="share-loop" data-value="${i}">\n                        <i class="drawer fas fa-undo" title="${game.i18n.localize(`${a.Z.moduleName}.share.loop-button`)}"></i>\n                    </div>\n                    <div class="media-actions mute-action ${n?"active":""}" data-action="share-mute" data-value="${n}">\n                        <i class="drawer fas fa-volume-mute" title="${game.i18n.localize(`${a.Z.moduleName}.share.mute-button`)}"></i>\n                    </div>\n                `)}}(i,"image"===s?n.attr("src"):n.attr("src")||n.find("source:first").attr("src"),s,o)}))},h=e=>{e.find(['span[data-action="share-popout"]'].join(",")).each(((e,a)=>{$._data(a,"events")||$(a).click((e=>{e.preventDefault(),e.stopPropagation();const a=$(e.currentTarget)[0];if(a){const e=f(a),t=b(a),i="";s(a.dataset.url,a.dataset.mode,i,e,t)}}))})),e.find(['span[data-action="share-scene"]'].join(",")).each(((e,a)=>{$._data(a,"events")||$(a).click((e=>{e.preventDefault(),e.stopPropagation();const a=$(e.currentTarget)[0];if(a){const e=f(a),t=b(a);l(a.dataset.url,a.dataset.style,a.dataset.type,e,t)}}))})),e.find(['span[data-action="share-fullscreen"]'].join(",")).each(((e,a)=>{$._data(a,"events")||$(a).click((e=>{e.preventDefault(),e.stopPropagation();const a=$(e.currentTarget)[0];if(a){const e=f(a),t=b(a),i=function(e){const a=$(e).closest("div.actions").find("span.immersive-action");return 0!==a.length&&"true"===a.attr("data-value")}(a),s="";n(a.dataset.url,a.dataset.mode,a.dataset.type,s,i,e,t)}}))})),e.find(['span[data-action="share-fullscreen-immersive"]'].join(",")).each(((e,a)=>{$._data(a,"events")||$(a).click((e=>{e.preventDefault(),e.stopPropagation();const a=$(e.currentTarget)[0];a&&($(a).toggleClass("active"),$(a).attr("data-value",$(a).hasClass("active")))}))})),e.find(['div[data-action="share-loop"]'].join(",")).each(((e,a)=>{$._data(a,"events")||$(a).click((e=>{e.preventDefault(),e.stopPropagation();const a=$(e.currentTarget)[0];a&&($(a).toggleClass("active"),$(a).attr("data-value",$(a).hasClass("active")))}))})),e.find(['div[data-action="share-mute"]'].join(",")).each(((e,a)=>{$._data(a,"events")||$(a).click((e=>{e.preventDefault(),e.stopPropagation();const a=$(e.currentTarget)[0];a&&($(a).toggleClass("active"),$(a).attr("data-value",$(a).hasClass("active")))}))})),e.find(['div[data-action="share-miro"]'].join(",")).each(((e,a)=>{$._data(a,"events")||$(a).click((e=>{e.preventDefault(),e.stopPropagation();const a=$(e.currentTarget)[0];a&&window["foundryvtt-miro-connector"].MiroAPI.sendJournalEntryImage(a.dataset.url)}))}))};function f(e){const a=$(e).closest("div.media-actions-container").find("div.media-actions.loop-action");return 0!==a.length&&"true"===a.attr("data-value")}function b(e){const a=$(e).closest("div.media-actions-container").find("div.media-actions.mute-action");return 0!==a.length&&"true"===a.attr("data-value")}function v(t=[],i){let n,s;"actors"===i?(n="actors",s="SIDEBAR.CharArt"):(n="items",s="ITEM.ViewArt");const o=t.find((e=>e.name===s)),l=t.findIndex((e=>e.name===s));o&&!l&&[{name:game.i18n.localize("share-media.context-entries.options"),icon:'<i class="fas fa-square-share-nodes"></i>',action:m}].forEach(((i,s)=>{const c=deepClone(o);c.name=i.name,c.icon=i.icon,c.callback=t=>{const s=game[n].get(t.data("documentId")),o=game.settings.get(a.Z.moduleName,e.L.SHARE_ACTOR_TOKEN_NAME)?s.name:"";i.action(s.img,o)},t.splice(l+1+s,0,c)}))}class N{static async sharePopoutMediaToAll(e,a="",t=!1,i=!0){this._validate(e,t,i),await s(e,"all",a,t,i)}static async sharePopoutMediaToSome(e,a="",t=!1,i=!0){this._validate(e,t,i),await s(e,"some",a,t,i)}static async shareFullscreenMediaToAll(e,a="",t=!1,i=!1,s=!0){this._validate(e,i,s);const o=[".mp4","webm"].includes(e.slice(-4).toLowerCase())?"video":"image";await n(e,"all",o,a,t,i,s)}static async shareFullscreenMediaToSome(e,a="",t=!1,i=!1,s=!0){this._validate(e,i,s);const o=[".mp4","webm"].includes(e.slice(-4).toLowerCase())?"video":"image";await n(e,"some",o,a,t,i,s)}static async shareSceneMediaFit(e,a=!1,t=!0,i=""){this._validate(e,a,t);const n=[".mp4","webm"].includes(e.slice(-4).toLowerCase())?"video":"image";await l(e,"fit",n,a,t,i)}static async shareSceneMediaCover(e,a=!1,t=!0,i=""){this._validate(e,a,t);const n=[".mp4","webm"].includes(e.slice(-4).toLowerCase())?"video":"image";await l(e,"cover",n,a,t,i)}static _validate(e,a,t){if(!e)throw new Error("Missing url parameter");if("boolean"!=typeof a)throw new Error("Loop parameter is not a valid boolean");if("boolean"!=typeof t)throw new Error("Mute parameter is not a valid boolean")}static clearBoundingTile(e=""){o(e)}}Hooks.once("init",(()=>{(0,e.Y)(),function(){const t=game.settings.get(a.Z.moduleName,e.L.ENABLE_SCENE_COVER)?"interface":"primary";CONFIG.Canvas.layers.shareMedia={layerClass:u,group:t}}()})),Hooks.once("ready",(()=>{g.Z.init(),setProperty(window,`${a.Z.moduleName}.API`,N),game.modules.get(a.Z.moduleName).API=N})),Hooks.on("getSceneControlButtons",(e=>{game.user.isGM&&(e=>{const t=e.find((e=>"tiles"===e.name));t&&t.tools.push({name:"create-bounding-tile",title:game.i18n.localize(`${a.Z.moduleName}.bounding-tile.create-button`),icon:"fas fa-border-style",visible:!0,onClick:()=>{!async function(){const e=r().length+1,t=await async function(e){const t=await renderTemplate(`${a.Z.modulePath}/templates/bounding-tile-creation-dialog.hbs`,{defaultName:game.i18n.localize(`${a.Z.moduleName}.dialogs.bounding-tile-creation.default-tile-name`)+` ${e}`});return d({id:"bounding-tile-creation-dialog",title:game.i18n.localize(`${a.Z.moduleName}.dialogs.bounding-tile-creation.title`),content:t,cancelLabel:game.i18n.localize(`${a.Z.moduleName}.dialogs.bounding-tile-creation.cancel-button`),validateLabel:game.i18n.localize(`${a.Z.moduleName}.dialogs.bounding-tile-creation.create-button`),validateCallback:e=>e.find("input").val().trim(),render:e=>e.find("input").focus(),top:ui.controls.element.position().top+80,left:ui.controls.element.position().left+110})}(e),i=c(t);if(i)return i.object.control(),ui.notifications.info(game.i18n.localize(`${a.Z.moduleName}.bounding-tile.create-already-exists`));const n={img:`${a.Z.modulePath}/images/transparent.png`,flags:{[a.Z.moduleName]:{isBounding:!0,name:t}},hidden:!0,width:canvas.scene.width,height:canvas.scene.height,x:canvas.scene.dimensions.sceneX,y:canvas.scene.dimensions.sceneY};await canvas.scene.createEmbeddedDocuments("Tile",[n]);const s=c(t);ui.notifications.info(game.i18n.localize(`${a.Z.moduleName}.bounding-tile.create-success`)),s.object.control()}()},button:!0},{name:"clear-bounding-tile",title:game.i18n.localize(`${a.Z.moduleName}.bounding-tile.clear-button`),icon:"fas fa-eraser",visible:!0,onClick:()=>{o()},button:!0})})(e)})),Hooks.on("renderTokenHUD",((t,i)=>{const n=game.settings.get(a.Z.moduleName,e.L.ENABLE_HUD_BUTTON);game.user.isGM&&n&&((t,i)=>{const n=$(`\n        <div class="control-icon " data-action="share-actor-img" title="${game.i18n.localize(`${a.Z.moduleName}.share.token-button`)}">\n            <i class="fas fa-book-open"></i>\n        </div>\n    `);n.click((()=>{const i=game.settings.get(a.Z.moduleName,e.L.SHARE_ACTOR_TOKEN_NAME)?t.object.document.name:"";m(t.object.document.texture.src,i)})),n.contextmenu((()=>{const i=game.settings.get(a.Z.moduleName,e.L.SHARE_ACTOR_TOKEN_NAME)?t.object.actor.name:"";m(t.object.actor.img,i)})),i.find(".col.left").append(n)})(t,i)})),Hooks.on("renderJournalPageSheet",((e,a)=>{p(a.closest(".journal-entry-pages")),h(a.closest(".journal-entry-pages"))})),Hooks.on("renderJournalSheet",((e,a)=>{"JournalSheet"!==e.constructor.name&&(p(a),h(a))})),Hooks.on("renderItemSheet",((e,a)=>{p(a),h(a)})),Hooks.on("renderActorSheet",((e,a)=>{p(a),h(a)})),Hooks.on("getActorDirectoryEntryContext",((t,i)=>{game.settings.get(a.Z.moduleName,e.L.DISABLE_CONTEXT_OPTIONS)||v(i,"actors")})),Hooks.on("getItemDirectoryEntryContext",((t,i)=>{game.settings.get(a.Z.moduleName,e.L.DISABLE_CONTEXT_OPTIONS)||v(i,"items")})),Hooks.on("renderGMNote",((e,a)=>{p(a),h(a)})),Hooks.on("canvasReady",(()=>{const e=canvas.scene.flags?.[a.Z.moduleName];if(e)for(let[a,{url:t,style:i,type:n,loop:s,mute:o}=value]of Object.entries(e))canvas.shareMedia.createBoundedSprite(a,t,i,"video"===n,s,o)})),Hooks.on("updateScene",((e,t)=>{if(t.flags?.[a.Z.moduleName]&&e.id===canvas.scene.id)for(let e of Object.keys(t.flags[a.Z.moduleName]))if(e.startsWith("-="))canvas.shareMedia.deleteBoundedSprite(e.substring(2));else{const t=canvas.scene.flags[a.Z.moduleName][e];canvas.shareMedia.createBoundedSprite(e,t.url,t.style,"video"===t.type,t.loop,t.mute)}t.hasOwnProperty("darkness")&&e.id===game.scenes.active?.id&&g.Z.updateDarkness(t.darkness)})),Hooks.on("updateTile",(e=>{if(e.flags?.[a.Z.moduleName]?.isBounding&&e.parent.id===canvas.scene.id){const t=canvas.scene.flags?.[a.Z.moduleName]?.[e.flags[a.Z.moduleName].name];t&&canvas.shareMedia.createBoundedSprite(e.flags[a.Z.moduleName].name,t.url,t.style,"video"===t.type,t.loop,t.mute)}})),Hooks.on("deleteTile",(e=>{if(game.user.isGM&&e.flags?.[a.Z.moduleName]?.isBounding&&e.parent.id===canvas.scene.id){const t=canvas.scene.flags?.[a.Z.moduleName]?.[e.flags[a.Z.moduleName].name];t&&canvas.scene.unsetFlag(a.Z.moduleName,e.flags[a.Z.moduleName].name)}}))}()}();